# IDEA
Geant4 simulation of the IDEA Detector

*******************************


 **TRACKER - Drift chamber + vertex detector** 
---
(DIRECTORY = DriftChamberPlusVertex)

-  Enter in simulation/ and edit envG4GMC.sh to change PRJBASE; then move in analyzer/ and edit envGMC.sh to change PRJBASE
   
-  To compile the simulation part:
   ```
   cd simulation
   source envG4GMC.sh
   cd g4GMC; make clean_all; make all	
   ```
   
-  To compile the analyzer:
   ```
   cd analyzer
   source envGMC.sh
   cd GMC
   source envMidasDAQ.sh
   make clean
   $ROMESYS/bin/romebuilder.exe -i GMC.xml
   make all
   ```
   
-  To compile readHits (which converts the hits.root file in a suitable format for GMCAnalyzer):
   ```
   cd ../simulation/g4GMC
   make readHits
   ```
   N.B. The previous compilation of the analyzer part is needed because of some dependencies required.
   
-  If everything works correctly, two executables are created in simulation/g4GMC/bin/Linux-g++: *g4GMC* and *readHits*.     
   Now, before running the simulation, the IDEA geometry has to be initialized and exported in a gdml format. 
   Edit the geometry configuration file:
    ```
   simulation/g4GMC/geom_IDEA.txt	
   ```
   setting TRUE the boolean variable *writeGDML* and choosing the gdml file name.
   
   After that, create an output directory for your work under the *simulation* dir. To run the simulation step and generate events:
   ```
   ./bin/Linux-g++/g4GMC g4mac/runPFix-1.mac geom_IDEA.txt 1 pathTo/outputDIR
   ```
   where the arguments are: 1) Geant4 card to handle the simulation parameters, 2) geometry configuration, 3) number given to the simulation, 4) output directory.
   
   Then type the following command to convert the file *hits#.root* generated by g4GMC in a suitable format for the analyzer (*MCData#.root*):
   ```
   ./bin/Linux-g++/readHits   pathTo/outputDIR/hits#.root
   ```
  N.B. It is also possible to launch the simulation in a parallelized way: 
   ```
   ./LaunchSims.sh  $1  $2  g4mac/runPFix-1.mac geom_IDEA.txt  pathTo/outputDIR
   ./ConvertHits.sh $1  $2
   ```
  where the arguments $1 and $2 correspond to nRuns and firstRun, respectively.
  
- Finally, modify the generated gdml file to make the simulation faster and set FALSE the boolean variable *writeGDML*:
   ```
   sed -e '/copynumber.*tubeFD_/,+4d' -e '/copynumber.*tubeSD_/,+4d' g4-IDEA.gdml > g4-IDEA_reco.gdml
   ```
   and move the gdml files in *simulation/g4GMC/config*. 
   
 - At the end, to run the analyzer and the reconstruction:
   1) Edit *geant4MC-IDEA.xml* and *geant4MC-IDEA-fit.xml* and change *<InputFilePath>outputDIR</InputFilePath>*; 
   2) Launch the analyzer and then the reconstruction:
   ```
   ./gmcanalyzer.exe -i geant4MC-IDEA.xml -r 1 -e 1-100
   ./gmcanalyzer.exe -i geant4MC-IDEA-fit.xml -r 1 -e 1-100
   ```
   or
    ```
   ${PRJBASE}/analyzer/GMC/LaunchAnalyzer.sh $1 $2 geant4MC-IDEA.xml hits
   ${PRJBASE}/analyzer/GMC/LaunchAnalyzer.sh $1 $2 geant4MC-IDEA-fit.xml reco
   ```
   All data information are stored in *MCHits#.root* and the reconstruction data are stored in *RecoData#.root*, respectively.
 
